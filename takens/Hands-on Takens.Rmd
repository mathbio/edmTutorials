---
title: "Hands-on Takens Theorem and State Space reconstruction"
subtitle: "School on Physics Applications in Biology, January 2018"
author: "Brenno Cabella, Roberto Kraenkel, Renato Coutinho, Paulo Inácio Prado, Rafael Lopes"
date: "`r format(Sys.time(), '%d de %B de %Y')`"
output:
         rmdformats::readthedown:
         self_contained: true
         thumbnails: true
         lightbox: true
         gallery: false
         highlight: tango
         toc_depth: 4
---

```{r setup, echo=FALSE, warning=FALSE, message=F}
library(knitr)#; library(zoo); library(xts)
library(plotly)
library(rEDM)
library(ggplot2)#; library(cowplot)
library(dplyr); library(tidyr)
library(deSolve)
library(xts)
library(rgl)
library(scatterplot3d)


opts_chunk$set(fig.align = 'center',
               fig.show = 'hold',
               fig.height = 5,
               warning = FALSE, message = FALSE, error = FALSE, echo=FALSE)
options(formatR.arrow = TRUE,width = 90)###, cache=TRUE)
```

This tutorial starts by presenting the general idea of Convergent Cross Mapping (Ye *et al.* 2017), next it shows some applied examples using syntetic data.
In the last section a real data analysis is proposed as an exercise.
For these activities, you will need the most recent version of [R](https://cran.r-project.org/) and the rEDM package installed in your working computer.

Before you proceed,
please read carefully the introduction and the first section (*"Empirical Dynamic Modelling"*) of
rEDM's tutorial that you can find [here](https://cran.r-project.org/web/packages/rEDM/vignettes/rEDM-tutorial.html) 
or in your local R installation with the command

## A system to study

This first part is to familiarize yourselves to the code language and be able to get the more complicated running with the course goes on, so we begin by trying to see how the theorem of Takens works to reconstruct a State space with only one time series and its lags.
For the first example we use a very well known system and its representation on state space, the bidimensional harmonic oscilator, we can draw the state space putting together in the same plot its two degrees of freedom, $x(t)$ and $y(t)$, its governing equation is, $\dot{x}=y, \dot{y}=-x$, and its state space:

```{r generate data for the harmonic oscilator, echo=TRUE}
t<-seq(1:100)
x<-sin(t)
y<-cos(t)

plot(x, y, type = 'p', main = "State-space of harmonic oscilator")
```

```{r time series of each variable}
plot(t, x, type = 'l', main = "Each one of the variables of the system", col = "red")
lines(t, y, col = "blue")
```

But not all time we have all the data about the system, in our example, we could not have one of the two time series which constitute the system, if $y(t)$ is missing we are not able to cosntruct a state space as we saw, but by using the result of Takens theorem we can construct a shadow amnifold of the original one, by lagging the remaing series and plotting all together in the same phase-space we reach the reconstruction of the first state space, besides its not equal to the original one it maps one-to-one to the original, and as said in theorem, being a valid topological recosntruction of the original, a "shadow" of the original.

```{r plot one time series alone}
df<-as.data.frame(x)
n <- NROW(df)
time<-seq(1:n)
```

## A reconstruction of the state space

Now we have to generate lags from the original series to be able to reconstruct the State space, and by plotting all together we get the shadow manifold which is similar to the original one:


```{r shadow manifold}
## Data frame with X at t0, t1 and t2
df1 <- data.frame(X.t0=X[1:(length(X)-2)],X.t1=X[2:(length(X)-1)],  X.t2=X[3:(length(X))])
## point to point Euclidian distance matrix
dist.m1 <- as.matrix(dist(df1[,1:3], upper=TRUE))
## Indexes of the 4 nearest neighbors of the last point in the time series
neigb1 <- order(dist.m1[(ncol(dist.m1)-1),])[2:5]
## Plot of the manifold: add colored markers on last point and their neighbors
p3 <- plot_ly(df1, x = ~X.t0, y=~X.t1, z=~X.t2, marker=(list(color=grey)), opacity=0.25) %>%
    layout(scene = list(xaxis = list(title = 'X'),
                        yaxis = list(title = 'X (t+1)'),
                        zaxis = list(title = 'X (t+2)'))) %>%
    add_markers(text = paste("time =",3:length(X)), showlegend = FALSE) %>%
    add_trace( x = ~X.t0, y=~X.t1, z=~X.t2, data=df1[c(length(X)-3,neigb1),],
              opacity=1,
              marker=list(color=c("blue","red","green","orange", "magenta")),
              type="scatter3d", mode="markers",
              text = paste("time =",rownames(df1[c(length(X)-3,neigb1),])), showlegend = FALSE) %>%
    add_trace(data=df1[c(length(X)-3, neigb1[1]),], mode="lines",
              line = list(width = 6, color = "blue"), showlegend = FALSE) %>%
    add_trace(data=df1[c(length(X)-3, neigb1[2]),], mode="lines",
              line = list(width = 6, color = "blue"), showlegend = FALSE)%>%
    add_trace(data=df1[c(length(X)-3, neigb1[3]),], mode="lines",
              line = list(width = 6, color = "blue"), showlegend = FALSE) %>%
    add_trace(data=df1[c(length(X)-3, neigb1[4]),], mode="lines",
              line = list(width = 6, color = "blue"), showlegend = FALSE)
p3

```

The neigbor points correspond to the states of the system 
most similar to the focal state that are available in the time series.
The plot below shows each of these states, with the same code color used
in the embbeding plot above.


```{r time series with neighbors highlighted}
time1 <- min(neigb1,length(X)):length(X) # syntatic sugar
plot(time1, X[time1] , xlab="Time", ylab="X", type="b", lty=3)
cores <- c("blue", "red","green","orange", "magenta")
z <- 1
for(i in c(length(X)-3,neigb1)){
    ind <- i:(i+2)
    lines(ind, X[ind], type="b", col=cores[z], lwd=2, pch=19)
    z <- z+1}
```


# Learn more

* Sugihara G. and R. M. May. 1990. Nonlinear forecasting as a way of distinguishing chaos 
from measurement error in time series. Nature 344:734–741.
* Sugihara G. 1994. Nonlinear forecasting for the classification of natural time series. 
Philosophical Transactions: Physical Sciences and Engineering 348:477–495.
* Anderson C. & Sugihara G. Simplex projection - Order out the chaos. http://deepeco.ucsd.edu/simplex/
* ["Simplex projection walkthrough"](http://opetchey.github.io/RREEBES/Sugihara_and_May_1990_Nature/Simplex_projection_walkthrough.html), a tutorial by Owen Petchey.


[^1]: This section is adapted from the tutorial ["Simplex projection walkthrough"](http://opetchey.github.io/RREEBES/Sugihara_and_May_1990_Nature/Simplex_projection_walkthrough.html), by Owen Petchey.

[^2]: The [next section](#sub2) shows some compealling evidence for this.

[^3]: For a full appraisal see: Deyle, E.R., Maher, M.C., Hernandez, R.D., Basu, S. and Sugihara, G., 2016. Global environmental drivers of influenza. Proceedings of the National Academy of Sciences, 113(46), pp.13081-13086.
